name: Publish Helm Charts

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # new numeric-only semantic version

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4
      - name: Package all charts
        run: |
          mkdir -p docs
          for chart in charts/*; do
            helm package "$chart" --destination docs/
          done
      - name: Reindex Helm repo
        run: |
          helm repo index docs --url https://john-ghatas.github.io/helmhub
      - name: Commit and push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add docs
          git commit -m "Helm chart release $GITHUB_REF" || echo "No changes to commit"
          git push
